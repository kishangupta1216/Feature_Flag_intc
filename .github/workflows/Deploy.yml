name: Deploy to GitHub Pages with Feature Flags

on:
  push:
    branches:
      - main
      - Feature_1
      - Feature_2
      - Feature_3

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/Feature_1' || github.ref == 'refs/heads/Feature_2' || github.ref == 'refs/heads/Feature_3' || github.ref == 'refs/heads/main'

    steps:
    - name: Checkout the code
      uses: actions/checkout@v2

    - name: Set up Git configuration
      run: |
        git config user.name "kishangupta1216"
        git config user.email "guptakishan1216@gmail.com"

    - name: Fetch the latest branches
      run: git fetch origin

    - name: Merge the feature branch into main
      run: |
        # Get the current branch name (either Feature_1 or Feature_2)
        CURRENT_BRANCH=${GITHUB_REF##*/}

        # Checkout to main
        git checkout main

        # Pull the latest changes from the remote main branch
        git pull origin main

        # Merge the feature branch into main
        git merge origin/$CURRENT_BRANCH --no-ff -m "Merge $CURRENT_BRANCH into main"

    - name: Push the merged changes to main
      run: |
        git push origin main


    - name: Initialize gh-pages branch (if not exists)
      run: |
        git fetch origin gh-pages || git checkout --orphan gh-pages  # Create the gh-pages branch if it doesn't exist
        git reset --hard  # Reset to ensure no uncommitted changes
        git clean -fd  # Clean up any untracked files

    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: gh-pages
        folder: ./ # Make sure this is the folder generated by the build process
        token: ${{ secrets.GH_TOKEN }}

    - name: Clean up and set feature flag (optional)
      run: |
        echo "Setting feature flag for branch ${GITHUB_REF}"
        echo "Feature flag deployed: ${GITHUB_REF}" > ./index.html
